---
title: "[VulkanRT] 1. Multi BLAS"
categories:
  - Devs
tags: [Devs, Vulkan, RayTracing]
---


![multi_blas_capture]({{site.baseurl}}/assets/img/multi_blas_capture.jpg)
<em>Nsight Graphics 캡쳐</em>

하나의 gltf model을 하나의 BLAS로 생성하는 기존의 구조 대신 Mesh마다 BLAS 생성\
Keywords : Goemetry Node Structure in RT\
Codes: [MyDevs/myRayTracingLittleAdvanced/myMultiBLAS.cpp](https://github.com/WOOYOUNGJAE/VulkanMyDevs/blob/master/MyDevs/myRayTracingLittleAdvanced/myMultiBLAS.cpp)

![multi_blas_model]({{site.baseurl}}/assets/img/multi_blas_model.jpg)

gltf 모델은 Node-Mesh-Primitive 라는 계층을 가지는데,\
예를 들어 그림처럼 사람이 하나의 Mesh로 표현되면 머리, 몸통, 다리는 하위 계층의 Primitive로 존재한다.\
이번에 시도해본 Multi BLAS 구조는 하나의 gltf Mesh가 하나의 BLAS가 되고, 하위의 gltf Primitive는 하나의 BLAS Geometry(BLAS 하위)가 된다.


### ray와 교차한 삼각형이 buffer을 찾아가는 과정
```glsl
// simplified code
struct GeometryNode {
	uint32_t vertexStartOffset;
	uint32_t indexStartOffset;
	uint32_t primitiveStartOffset;
};

struct Primitive
{
	uint32_t vertexStartOffsetInMesh;
	uint32_t IndexStartOffsetInMesh;
	// material infos per primitive
	// ..
};

void findTriangle()
{
	// Get GeometryNode(Mesh's) via hit BLAS instance (gl_InstanceID)
	GeometryNode geometryNode = sceneNodes[gl_InstanceID];
	// gl_GeometryIndexEXT represents current gltf primitive from mesh
	Primitive meshPrimitive = scenePrimitives[geometryNode.primitiveStartOffset + gl_GeometryIndexEXT];
	
	uint64_t vertexAddress = sceneDeviceAddress.vertexBufferAddress; // vertex buffer is combinded single buffer
	uint64_t triangleIndexOffsetInBytes = 
		INDEX_TYPE_SIZE * (geometryNode.indexStartOffset + meshPrimitive.IndexStartOffsetInMesh + (gl_PrimitiveID * 3));
	uint64_t currentTriangleAddress = sceneDeviceAddress.indexBufferAddress + triangleIndexOffsetInBytes;

	Vertices   vertices = Vertices(vertexAddress);
	Indices    indices = Indices(currentTriangleAddress);	

	//..
}

```

**ray와 삼각형이 충돌하였을 때 알 수 있는 것**

    1. 어떤 BLAS instance인지 (gl_InstanceID)
    2. BLAS instance를 구성하는 geometry 중 어떤 것인지 (gl_GeometryIndexEXT)
    3. 2번의 geometry 중 몇 번째 삼각형인지 (gl_PrimitiveID)

1. blas instance와 mesh 는 1대1 대응이기 때문에 mesh가 갖고 있는 geometryNode 데이터를 가져온다.
2. geometryNode의 primitiveStartOffset을 통해 mesh가 갖고 있는 meshPrimitive의 시작 지점을 받아낸 후 gl_GeometryIndexEXT을 추가적으로 더하여 현 삼각형이 속한 meshPrimitive를 찾는다.
3. geometryNode의 indexStartOffset, meshPrimitive의 IndexStartOffsetInMesh을 활용해 scene의 전체 index buffer 중 현 삼각형의 첫 index 지점(device address) 를 찾아낸다.